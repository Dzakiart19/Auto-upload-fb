# Overview

This project is a TypeScript-based automation system designed to automate media uploads (videos and photos) to Facebook Pages and sharing to Facebook Groups. It is triggered by media content received via Telegram. The system supports AI-powered agents with memory for enhanced interaction and workflow orchestration, but can also operate in a fallback mode without AI.

Key capabilities include:
- **Media Type Support**: Handles both videos and photos from Telegram.
- **Simple Caption System**: Uses user input directly, augmented with auto-generated trending hashtags (up to 15) based on content category and title keywords, supporting Indonesian and English.
- **Video Processing**: Automatic format conversion using FFmpeg, smart upload method selection, and automated sharing to multiple Facebook Groups.
- **Photo Processing**: Direct upload with validation for file size and format integrity.
- **AI-Assisted Processing**: Optional workflow orchestration using OpenAI models with a robust fallback mechanism.
- **Robust Error Handling**: Automatic retry with exponential backoff and network-level error handling.
- **Automatic Cleanup**: Deletes temporary files after upload.
- **URL Auto-Extraction**: Automatically detects and processes TikTok/Instagram URLs, extracting metadata for direct upload.

# User Preferences

Preferred communication style: Simple, everyday language.

**Caption Style Preference**:
- User prefers SIMPLE captions - use their input directly without modifications.
- NO "alay" style with excessive emojis, call-to-actions, or engagement footers.
- NO phrases like: "Cek ini!", "Follow untuk konten lebih seru!", "Tag teman kamu!", "Double tap!", etc.
- Format: Just user's title/description + hashtags (hashtags are OK).
- Keep it clean and straightforward - let the content speak for itself.

# System Architecture

## Core Framework
- **Mastra Framework**: Orchestrates agents, tools, and workflows.
- **Inngest Integration**: Provides durable execution, step memoization, and reliable recovery.
- **TypeScript/Node.js**: Modern ES2022 modules with strict type checking.

## Agent Architecture
- **AI Agents**: Utilize OpenAI models (GPT-4o/GPT-4o-mini) via AI SDK for autonomous reasoning.
- **Memory System**: Includes working memory, conversation history, and semantic recall for long-term context.
- **Agent Networks**: Routing agents coordinate specialized agents for complex tasks.

## Workflow Engine
- **Graph-Based Workflows**: Explicit control flow with steps, branching, and parallel execution.
- **Suspend/Resume**: Human-in-the-loop support with state persistence via snapshots.
- **Streaming Support**: Real-time incremental responses.
- **Error Handling**: Configurable retry policies.

## Tool System
- **Structured Tools**: Type-safe functions with Zod schema validation.
- **Tool Streaming**: Incremental results during execution.

## Trigger System
- **Webhook Handlers**: Supports Telegram and custom connectors for event processing.
- **State Management**: Tracks conversation flow for multi-turn interactions.

## Memory and Storage
- **Storage Adapters**: Pluggable backends including LibSQL, PostgreSQL (with pgvector), and Upstash Redis.
- **Thread/Resource Scoping**: Isolates memory per conversation or persists across user sessions.
- **Snapshot Persistence**: Saves workflow state for suspend/resume.

## UI/UX Decisions
- **Telegram Bot Interface**: Primary user interaction channel for media submission and updates.
- **Mastra Playground UI**: Visualizes workflow graphs and nodes for development.

## Technical Implementations
- **Simple Caption & Hashtag System**: Uses user input directly and generates up to 15 trending hashtags based on content category (meme, gaming, tutorial, etc.), optimized for the Indonesian absurd/brainrot/random niche. Hashtags are generated by a `generateTrendingHashtags` tool, focusing on niche-specific tags over generic viral ones.
- **Media Type Branching**: A single workflow intelligently branches to handle videos (download, FFmpeg convert, upload, share to groups, notify) and photos (download, upload, notify).
- **Workflow Branching for Manual & URL Uploads**: Explicit branching using an `isUrlFlow` flag separates manual Telegram file uploads from URL-based (TikTok/Instagram) processing, ensuring correct data validation and flow.
- **Simplified Manual Upload Flow**: Streamlined to two steps: send media, then enter title. Hashtags are automatically generated based on the title, removing the need for explicit description input from the user.
- **Facebook Video Upload**: Handles proper `Content-Type`, filename, and metadata, automatically selecting between simple and resumable uploads based on file size. Includes enhanced retry logic with exponential backoff and network-level error handling.
- **Facebook Photo Upload**: Uses the `facebookUploadPhoto` tool for direct uploads, including validation for file size (< 8MB) and MIME types (JPEG, PNG, GIF, WebP, BMP), along with magic number validation for file integrity.
- **FFmpeg Video Conversion**: The `ffmpegConvertVideo` tool converts videos to Facebook-compatible formats (H.264/AAC) using optimized parameters for quality and compatibility, with automatic cleanup of original and converted files.
- **Telegram Media Handling**: `telegramDownloadVideo` and `telegramDownloadPhoto` tools download media to temporary directories, preserving original extensions and performing size validation.
- **Instagram & TikTok Auto-Extract & Upload**: The bot automatically detects TikTok/Instagram URLs, downloads content, extracts metadata (caption, hashtags, author), and uploads directly to Facebook without requiring user input for captions or hashtags. It utilizes `insta-fetcher` for Instagram and `@tobyg74/tiktok-api-dl` for TikTok.
- **Facebook Upload Optimizations**: Fixed resumable upload issues by sending metadata via POST body using FormData with `axios` for Node.js compatibility, supporting long captions and descriptions.
- **AI Fallback Mechanism**: The system can operate without an OpenAI API key, directly executing tools, configurable via `AI_FALLBACK_ENABLED`.

## Design Patterns
- **Provider-Agnostic Models**: Unified interface for multiple AI providers.
- **Model Fallbacks**: Automatic provider switching on failures.
- **Processor Pipeline**: Input/output processors for guardrails and content transformation.
- **Zod Validation**: Schema-first design for data structures.

# External Dependencies

## AI Services (Optional)
- **OpenAI**: Primary LLM provider.
- **OpenRouter**: Alternative AI provider gateway.

## Messaging Platforms
- **Telegram Bot API**: For media reception and user interaction.

## Social Media APIs
- **Facebook Graph API**: For video/photo uploads to Pages and sharing to Groups.
- **insta-fetcher**: Library for Instagram content download and metadata extraction.
- **@tobyg74/tiktok-api-dl**: Library for TikTok content download and metadata extraction.

## Database and Storage
- **LibSQL**: Embedded/local database.
- **PostgreSQL**: Optional storage backend with `pgvector`.
- **Upstash**: Redis and Vector database cloud service.

## Workflow Infrastructure
- **Inngest**: Serverless workflow orchestration.

## Third-Party Integrations
- **MCP (Model Context Protocol)**: Extensible tool integration.
- **Form Data Handling**: For multipart form uploads (via `axios`).
- **FFmpeg**: Video transcoding and format conversion (system dependency).

## Configuration Files
- `.env`: Environment variables for API keys and tokens.
- `groups.txt`: Stores Facebook Group IDs for automated sharing.

## Health Check & Monitoring
- **Health Endpoint**: `/health` for monitoring services, providing status, uptime, timestamp, and service name.